<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spektrum Dark Pro</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00f260;
            --secondary: #0575e6;
            --accent: #f5af19;
            --glass: rgba(0, 0, 0, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text: #ffffff;
            --team-a: #ff4757;
            --team-b: #00ccff;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e, #000000);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--text);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            text-shadow: 2px 2px 0px #000000, 0 0 10px rgba(0,0,0,0.8);
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- LAYOUT --- */
        .sidebar {
            width: 280px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--glass-border);
            transition: 0.3s;
            overflow-y: auto;
        }
        
        .sidebar-right {
            border-right: none;
            border-left: 1px solid var(--glass-border);
        }

        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .game-card {
            width: 100%;
            max-width: 750px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            text-align: center;
            animation: fadeIn 0.5s ease-out;
            position: relative;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- TYPOGRAPHY & UI --- */
        h1 { font-weight: 900; letter-spacing: 3px; margin: 0 0 10px 0; color: var(--accent); }
        h2 { font-weight: 700; color: #fff; margin-bottom: 15px; }
        h3 { font-weight: 400; margin: 10px 0; }

        .screen { display: none; }
        .active { display: block; animation: fadeIn 0.5s; }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 700;
            font-family: 'Poppins', sans-serif;
            margin: 8px;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            color: white;
            text-shadow: 1px 1px 2px black;
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 0.9em;
        }

        .btn-primary { background: linear-gradient(45deg, #00b09b, #96c93d); }
        .btn-primary:hover { transform: scale(1.05); filter: brightness(1.2); }
        
        .btn-secondary { background: linear-gradient(45deg, #FF416C, #FF4B2B); }
        .btn-secondary:hover { transform: scale(1.05); filter: brightness(1.2); }

        .btn-team-a { background: linear-gradient(45deg, #ff416c, #ff4757); }
        .btn-team-b { background: linear-gradient(45deg, #00c6ff, #0072ff); }

        .btn-disabled { background: #444; cursor: not-allowed; opacity: 0.5; filter: grayscale(1); }

        /* INPUTY I SELECTY */
        input[type="text"], input[type="number"], select {
            padding: 12px;
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(0,0,0,0.5);
            color: white;
            font-size: 1em;
            width: 60%;
            text-align: center;
            outline: none;
            font-family: 'Poppins', sans-serif;
            margin: 5px 0;
        }
        
        select {
            background: #fff;
            color: #000;
            border-color: var(--accent);
            cursor: pointer;
            font-weight: bold;
            width: 65%;
            text-shadow: none;
        }
        option { background: #fff; color: #000; }

        .config-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.05);
            padding: 10px 20px;
            margin: 5px 0;
            border-radius: 10px;
        }

        /* --- SPECTRUM BAR --- */
        .spectrum-wrapper {
            position: relative;
            width: 100%;
            height: 50px;
            background: linear-gradient(90deg, #ff0055 0%, #ffcc00 50%, #00ccff 100%);
            border-radius: 25px;
            margin: 30px 0 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5), inset 0 3px 10px rgba(0,0,0,0.3);
            border: 3px solid rgba(255,255,255,0.1);
        }

        .marker {
            position: absolute;
            width: 6px;
            height: 60px;
            background: #fff;
            top: -8px;
            border: 2px solid #000;
            border-radius: 4px;
            transform: translateX(-50%);
            transition: left 0.4s cubic-bezier(0.22, 1, 0.36, 1);
            z-index: 2;
            pointer-events: none;
        }

        .marker-label {
            position: absolute;
            top: -45px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 900;
            color: #fff;
            background: #000;
            padding: 5px 12px;
            border-radius: 8px;
            border: 1px solid var(--accent);
            white-space: nowrap;
        }

        .guess-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 50px;
            background: transparent;
            position: absolute;
            top: 0; left: 0;
            z-index: 10;
            cursor: pointer;
            opacity: 0;
        }

        .category-box {
            background: rgba(0,0,0,0.6);
            padding: 15px;
            margin: 15px 0;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            font-size: 1.1em;
            text-transform: uppercase;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .score-row {
            display: flex; justify-content: space-between; padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 1em;
        }
        
        .status-item {
            padding: 8px; margin: 6px 0; border-radius: 8px; font-size: 0.85em;
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
        }
        .status-done { color: #2ecc71; border-color: #2ecc71; }
        .status-pending { color: #e74c3c; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        .room-code { font-size: 2.5em; font-weight: 900; letter-spacing: 5px; color: var(--accent); margin: 10px 0; }
        #error-msg { color: #ff4757; font-weight: bold; min-height: 20px; text-shadow: none; background: rgba(0,0,0,0.5); display: inline-block; padding: 0 10px; border-radius: 5px;}

        /* TIMER BAR */
        #timer-bar-container {
            width: 100%; height: 6px; background: rgba(255,255,255,0.1); margin-bottom: 20px; border-radius: 3px; display: none;
        }
        #timer-bar-fill {
            height: 100%; background: var(--accent); width: 100%; transition: width 1s linear;
        }

        /* TEAMS UI */
        .team-col { flex:1; padding: 10px; border-radius: 10px; margin: 5px; }
        .team-a-bg { background: rgba(255, 71, 87, 0.2); border: 1px solid var(--team-a); }
        .team-b-bg { background: rgba(0, 204, 255, 0.2); border: 1px solid var(--team-b); }

        @media (max-width: 800px) {
            body { flex-direction: column; overflow-y: scroll; height: auto; }
            .sidebar { width: 100%; height: auto; padding: 10px; order: 2; border-right: none; border-top: 1px solid var(--glass-border); }
            .main-content { padding: 10px; order: 1; min-height: 85vh; }
            .category-box { flex-direction: column; gap: 5px; font-size: 0.9em; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>üèÜ Wyniki</h2>
        <div id="score-header" style="text-align:center; margin-bottom:10px; font-size:0.9em; opacity:0.8"></div>
        <div id="score-table"></div>
        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <p>Runda: <span id="ui-current-round" style="color:var(--accent);">0</span> / <span id="ui-total-rounds">0</span></p>
        </div>
    </div>

    <div class="main-content">
        <div class="game-card">
            <h1>SPEKTRUM <span style="font-size:0.5em; vertical-align:middle; color:var(--primary)">PRO</span></h1>
            <div id="error-msg"></div>

            <div id="screen-menu" class="screen active">
                <button class="btn-primary" onclick="showScreen('screen-host-setup')">Nowa Gra</button>
                <button class="btn-secondary" onclick="showScreen('screen-join-setup')">Do≈ÇƒÖcz</button>
            </div>

            <div id="screen-host-setup" class="screen" style="text-align: left;">
                <h2 style="text-align:center">Ustawienia Gry</h2>
                <div style="text-align:center; margin-bottom:20px;">
                    <input type="text" id="host-nick" placeholder="Tw√≥j Nick" maxlength="12">
                </div>

                <div class="config-row">
                    <span>Tryb gry:</span>
                    <select id="cfg-mode" onchange="toggleTeamInputs()" style="width:140px;">
                        <option value="FFA">Ka≈ºdy na Ka≈ºdego</option>
                        <option value="TEAM">Dru≈ºynowy (2 Teamy)</option>
                    </select>
                </div>

                <div id="team-names-cfg" style="display:none; flex-direction:column; gap:5px; margin-bottom:10px;">
                    <input type="text" id="cfg-team-a" value="Czerwoni" style="width:90%; color:var(--team-a); border-color:var(--team-a);">
                    <input type="text" id="cfg-team-b" value="Niebiescy" style="width:90%; color:var(--team-b); border-color:var(--team-b);">
                </div>

                <div class="config-row">
                    <span>Liczba rund:</span>
                    <select id="cfg-rounds" style="width:80px;">
                        <option value="2">2</option>
                        <option value="3" selected>3</option>
                        <option value="5">5</option>
                        <option value="10">10</option>
                    </select>
                </div>

                <div class="config-row">
                    <span>Podpowiedzi na osobƒô:</span>
                    <select id="cfg-hints-count" style="width:80px;">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                    </select>
                </div>

                <div class="config-row">
                    <span>Limit czasu (0 = brak):</span>
                    <input type="number" id="cfg-timer" value="0" min="0" max="60" style="width:60px;"> s
                </div>
                <p style="font-size:0.7em; opacity:0.6; text-align:center; margin:0;">Zalecane 5-15s na podpowied≈∫ w trybie szybkim.</p>

                <div style="text-align:center; margin-top:20px;">
                    <button class="btn-secondary" onclick="showScreen('screen-menu')">Wr√≥ƒá</button>
                    <button class="btn-primary" onclick="createGame()">Utw√≥rz Lobby</button>
                </div>
            </div>

            <div id="screen-join-setup" class="screen">
                <h2>Do≈ÇƒÖczanie</h2>
                <input type="text" id="join-nick" placeholder="Tw√≥j Nick" maxlength="12">
                <input type="number" id="join-code" placeholder="4-cyfrowy kod">
                <br><br>
                <button class="btn-secondary" onclick="showScreen('screen-menu')">Wr√≥ƒá</button>
                <button class="btn-primary" onclick="joinGame()">Do≈ÇƒÖcz</button>
            </div>

            <div id="screen-lobby" class="screen">
                <h3>KOD POKOJU:</h3>
                <div id="display-code" class="room-code">...</div>
                
                <div id="lobby-mode-info" style="font-size:0.8em; margin-bottom:10px;"></div>

                <div id="lobby-container" style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px;">
                    </div>
                
                <div id="team-selector" style="display:none; margin-top:20px;">
                    <p>Wybierz dru≈ºynƒô:</p>
                    <button class="btn-team-a" onclick="selectTeam('A')">TEAM A</button>
                    <button class="btn-team-b" onclick="selectTeam('B')">TEAM B</button>
                </div>

                <div id="controls-host" style="display:none; margin-top:30px;">
                    <button id="btn-start" class="btn-disabled" onclick="serverStartGame()" disabled>Rozpocznij Grƒô</button>
                </div>
                <div id="controls-client" style="display:none; margin-top:30px;">
                    <button id="btn-ready" class="btn-secondary" onclick="toggleReady()">Gotowy</button>
                </div>
            </div>

            <div id="screen-hinting" class="screen">
                <div id="timer-bar-container"><div id="timer-bar-fill"></div></div>
                <div id="timer-display" style="font-size:1.5em; font-weight:bold; color:var(--accent);"></div>

                <div id="view-guesser-wait">
                    <h2>Jeste≈õ ZgadujƒÖcym!</h2>
                    <p style="opacity:0.8">Poczekaj, a≈º Twoja dru≈ºyna wymy≈õli podpowiedzi.</p>
                    <div style="font-size: 4em; animation: pulse 2s infinite;">ü§´</div>
                </div>

                <div id="view-hinter-active" style="display:none;">
                    <h3>TWOJA TAJNA LICZBA</h3>
                    <div class="spectrum-wrapper">
                        <div id="hint-marker" class="marker"><span class="marker-label" id="hint-marker-label">?</span></div>
                    </div>
                    
                    <div class="category-box">
                        <span id="cat-left" style="color:#ff4757">...</span>
                        <span id="cat-right" style="color:#00ccff">...</span>
                    </div>

                    <p id="hint-counter-ui" style="font-size:0.9em;">Podpowied≈∫ 1/1</p>
                    <input type="text" id="hint-input" placeholder="Wpisz s≈Çowo..." autocomplete="off">
                    <br><br>
                    <button class="btn-primary" onclick="clientSubmitHint()">Wy≈õlij</button>
                </div>
            </div>

            <div id="screen-guessing" class="screen">
                <p>ZGADUJE: <b id="ui-guesser-name" style="color:var(--accent);"></b></p>
                
                <div class="category-box">
                    <span id="guess-cat-left" style="color:#ff4757"></span>
                    <span id="guess-cat-right" style="color:#00ccff"></span>
                </div>

                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 20px 0; border: 1px solid var(--accent); position:relative;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <button class="btn-secondary" style="padding:5px 15px; font-size:0.7em;" onclick="navHint(-1)">‚¨Ö</button>
                        <span style="font-size:0.7em; text-transform:uppercase;">Od: <span id="ui-hinter-name"></span></span>
                        <button class="btn-secondary" style="padding:5px 15px; font-size:0.7em;" onclick="navHint(1)">‚û°</button>
                    </div>
                    <div id="ui-hint-word" style="font-size: 2.2em; font-weight: 900; color: var(--accent); text-transform: uppercase;"></div>
                    <div id="ui-hint-index" style="font-size:0.7em; margin-top:5px; opacity:0.6">1 / 1</div>
                </div>

                <div id="guesser-controls" style="display:none;">
                    <div id="final-guess-ui">
                        <p>PRZESU≈É SUWAK I ZATWIERD≈π!</p>
                        <div class="spectrum-wrapper">
                            <input type="range" min="1" max="100" value="50" class="guess-slider" id="guess-range" oninput="updateGuessMarker(this.value)">
                            <div id="guess-marker-visual" class="marker" style="left: 50%;">
                                <span class="marker-label" id="guess-val-display">50</span>
                            </div>
                        </div>
                        <br>
                        <button class="btn-primary" onclick="clientSubmitGuess()">ZGADUJƒò!</button>
                    </div>
                </div>
                <p id="guesser-wait-msg" style="display:none; opacity:0.7;">Tylko zgadujƒÖcy mo≈ºe sterowaƒá suwakiem.</p>
            </div>

            <div id="screen-result" class="screen">
                <h2 id="res-title" style="font-size: 2.5em; text-transform: uppercase;">WYNIK</h2>
                
                <div class="spectrum-wrapper" style="margin-bottom: 60px;">
                    <div id="res-marker-target" class="marker" style="background:var(--accent); z-index:1; border-color:white;">
                        <span class="marker-label" style="background:var(--accent); color:black;">CEL</span>
                    </div>
                    <div id="res-marker-guess" class="marker" style="background:#fff; z-index:2; top:10px; height:40px;">
                        <span class="marker-label" style="top:40px; background:#fff; color:black;">TY</span>
                    </div>
                </div>

                <div style="display: flex; justify-content: center; gap: 40px; font-size: 1.5em; margin-bottom: 20px;">
                    <div>Cel: <b id="res-target-val" style="color:var(--accent)"></b></div>
                    <div>Strza≈Ç: <b id="res-guess-val"></b></div>
                </div>

                <div id="res-points" style="font-size: 2.5em; color: var(--primary); font-weight:900;"></div>

                <div id="host-next-turn" style="display:none;">
                    <button class="btn-primary" onclick="serverNextTurn()">Dalej ‚û°</button>
                </div>
                <p id="client-wait-msg" style="display:none; opacity:0.7;">Oczekiwanie na lidera...</p>
            </div>

            <div id="screen-final" class="screen">
                <h1 style="font-size: 3em; color: var(--accent);">KONIEC</h1>
                <h2 id="winner-name"></h2>
                <div id="final-leaderboard" style="margin: 30px 0;"></div>
                <div id="host-restart" style="display:none;">
                    <button class="btn-primary" onclick="location.reload()">Nowe Lobby</button>
                </div>
            </div>

        </div>
    </div>

    <div class="sidebar sidebar-right">
        <h2>üí¨ Status</h2>
        <div id="status-list"></div>
    </div>

<script>
    const CATS = [
        ["Najgorszy dodatek do pizzy", "Najlepszy dodatek do pizzy"],
        ["Tani prezent ≈õlubny", "Drogi prezent ≈õlubny"],
        ["Film, na kt√≥rym za≈õniesz", "Film, kt√≥ry zmieni twoje ≈ºycie"],
        ["Bezu≈ºyteczna supermoc", "Niezbƒôdna supermoc"],
        ["Piosenka do windy", "Hymn stadionu"],
        ["Jedzenie, kt√≥re brudzi rƒôce", "Jedzenie idealne na randkƒô"],
        ["Bezpieczne hobby", "≈ömiertelnie niebezpieczne hobby"],
        ["Praca dla introwertyka", "Praca dla ekstrawertyka"],
        ["Zapach ze stacji benzynowej", "Zapach perfumerii"],
        ["Najgorsze miejsce na o≈õwiadczyny", "Idealne miejsce na o≈õwiadczyny"],
        ["Tani samoch√≥d", "Luksusowy jacht"],
        ["Plotka", "Fakt naukowy"],
        ["Co≈õ miƒôkkiego", "Co≈õ twardszego od diamentu"],
        ["Bohater z bajki", "Postaƒá z horroru"],
        ["MƒÖdra inwestycja", "Wyrzucanie pieniƒôdzy w b≈Çoto"],
        ["≈Åatwy przedmiot w szkole", "Koszmar studenta"],
        ["Lekka przekƒÖska", "Obiad u babci"],
        ["Legalne", "Do≈ºywocie"],
        ["Zdrowe ≈õniadanie", "Zawa≈Ç serca na talerzu"],
        ["S≈Çaby tekst na podryw", "Mistrzowski flirt"],
        ["Wstydliwa przyjemno≈õƒá", "Pow√≥d do dumy"],
        ["Zimne jak l√≥d", "GorƒÖce jak s≈Ço≈Ñce"],
        ["Kr√≥tkotrwa≈Ça moda", "Ponadczasowy styl"],
        ["Najgorszy smak lod√≥w", "Najlepszy smak lod√≥w"]
    ];

    const PREFIX = "spektrum-pro-";
    let peer, myConn, hostConns = [], isHost = false, myNick = "";
    
    // Konfiguracja domy≈õlna
    let gameConfig = {
        mode: 'FFA', // 'FFA' lub 'TEAM'
        rounds: 3,
        hintsPerUser: 1,
        timerSeconds: 0,
        teamNames: {A: "Czerwoni", B: "Niebiescy"}
    };

    let state = {
        phase: 'LOBBY',
        config: gameConfig,
        players: [],
        teams: { A: {score:0}, B: {score:0} },
        currentRound: 1,
        turnIndex: 0, 
        target: 50,
        guess: 50,
        
        // Dane rundy
        activeCategory: [],
        collectedHints: [], // {word, sender, team}
        timeLeft: 0,
        lastPoints: 0,
        
        // Stan przeglƒÖdania (tylko lokalnie dla UI, ale trzymam w state dla sp√≥jno≈õci logicznej)
        viewHintIdx: 0 
    };
    
    // Interval timera
    let timerInterval = null;

    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function error(m) { document.getElementById('error-msg').innerText = m; setTimeout(()=>document.getElementById('error-msg').innerText="", 3000); }
    function toggleTeamInputs() {
        let m = document.getElementById('cfg-mode').value;
        document.getElementById('team-names-cfg').style.display = (m === 'TEAM') ? 'flex' : 'none';
    }

    // --- SETUP ---
    function createGame() {
        myNick = document.getElementById('host-nick').value.trim();
        if(!myNick) return error("Podaj nick!");

        gameConfig.mode = document.getElementById('cfg-mode').value;
        gameConfig.rounds = parseInt(document.getElementById('cfg-rounds').value);
        gameConfig.hintsPerUser = parseInt(document.getElementById('cfg-hints-count').value);
        gameConfig.timerSeconds = parseInt(document.getElementById('cfg-timer').value);
        
        if(gameConfig.mode === 'TEAM') {
            gameConfig.teamNames.A = document.getElementById('cfg-team-a').value || "Team A";
            gameConfig.teamNames.B = document.getElementById('cfg-team-b').value || "Team B";
        }

        let code = Math.floor(1000 + Math.random()*9000).toString();
        isHost = true;
        
        if(peer) peer.destroy();
        peer = new Peer(PREFIX + code);
        
        peer.on('open', id => {
            state.config = gameConfig;
            // Host domy≈õlnie w TEAM A je≈õli tryb team
            let startTeam = (gameConfig.mode === 'TEAM') ? 'A' : null;
            state.players = [{id, nick: myNick, score: 0, ready: true, isHost: true, team: startTeam, hintsGiven: 0}];
            
            document.getElementById('display-code').innerText = code;
            document.getElementById('controls-host').style.display = 'block';
            showScreen('screen-lobby'); render();
            
            peer.on('connection', c => {
                hostConns.push(c);
                c.on('data', d => handleServerData(d, c));
                c.on('close', () => { 
                    state.players = state.players.filter(p => p.id !== c.peer);
                    broadcast();
                });
            });
        });
        peer.on('error', () => createGame());
    }

    function joinGame() {
        myNick = document.getElementById('join-nick').value.trim();
        let code = document.getElementById('join-code').value.trim();
        if(!myNick || code.length !== 4) return error("B≈Çƒôdne dane!");
        
        if(peer) peer.destroy();
        peer = new Peer();
        
        peer.on('open', () => {
            myConn = peer.connect(PREFIX + code);
            myConn.on('open', () => {
                myConn.send({type: 'JOIN', nick: myNick});
                document.getElementById('display-code').innerText = code;
                document.getElementById('controls-client').style.display = 'block';
                showScreen('screen-lobby');
            });
            myConn.on('data', d => { state = d; render(); });
            setTimeout(()=>{ if(!myConn.open) error("Nie znaleziono pokoju"); }, 3000);
        });
    }

    // --- HOST LOGIC ---
    function handleServerData(d, conn) {
        let p = state.players.find(x => x.id === conn.peer);
        
        if(!p && d.type === 'JOIN') {
            // Domy≈õlny team w trybie team to B (≈ºeby balansowaƒá z Hostem) lub null
            let t = (state.config.mode === 'TEAM') ? 'B' : null;
            state.players.push({id: conn.peer, nick: d.nick, score: 0, ready: false, isHost: false, team: t, hintsGiven: 0});
        }
        else if(p) {
            if(d.type === 'READY') p.ready = d.val;
            if(d.type === 'TEAM_CHANGE') p.team = d.val;
            
            if(d.type === 'HINT') { 
                state.collectedHints.push({word: d.word, sender: p.nick, team: p.team});
                p.hintsGiven++;
                checkAllHints(); 
            }
            
            if(d.type === 'GUESS') { state.guess = d.val; calcScore(); }
        }
        broadcast();
    }

    function broadcast() { render(); hostConns.forEach(c => c.open && c.send(state)); }

    function serverStartGame() {
        // Balans w trybie team nie jest wymagany, ale mo≈ºna dodaƒá walidacjƒô.
        if(state.config.mode === 'TEAM') {
            let countA = state.players.filter(p=>p.team==='A').length;
            let countB = state.players.filter(p=>p.team==='B').length;
            if(countA === 0 || countB === 0) { error("Ka≈ºda dru≈ºyna musi mieƒá gracza!"); return; }
        }
        
        state.currentRound = 1;
        state.turnIndex = 0;
        newTurn();
    }

    function newTurn() {
        state.phase = 'HINTING';
        state.target = Math.floor(Math.random()*100) + 1;
        state.collectedHints = [];
        state.activeCategory = CATS[Math.floor(Math.random()*CATS.length)];
        state.timeLeft = state.config.timerSeconds;

        // Reset licznik√≥w podpowiedzi
        state.players.forEach(p => p.hintsGiven = 0);

        // Wyb√≥r zgadujƒÖcego
        // W trybie FFA: rotacja po indexie
        // W trybie TEAM: rotacja, ale musimy wiedzieƒá czyj to ruch.
        // Uproszczenie: turnIndex po prostu idzie przez listƒô graczy.
        
        let guesser = state.players[state.turnIndex];
        state.guesserId = guesser.id;

        // Start Timera (tylko Host)
        if(state.config.timerSeconds > 0) {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                state.timeLeft--;
                if(state.timeLeft <= 0) {
                    clearInterval(timerInterval);
                    forceEndHinting();
                }
                broadcast();
            }, 1000);
        }

        broadcast();
    }

    function checkAllHints() {
        // Zliczamy ile podpowiedzi powinno byƒá
        // Wszyscy opr√≥cz guessera * hintsPerUser
        // W trybie Team: Wszyscy z DRU≈ªYNY GUESSERA (opr√≥cz niego)
        
        let needed = 0;
        let currentTotal = 0;

        if(state.config.mode === 'FFA') {
            let hinters = state.players.filter(p => p.id !== state.guesserId);
            needed = hinters.length * state.config.hintsPerUser;
            currentTotal = hinters.reduce((acc, p) => acc + p.hintsGiven, 0);
        } else {
            // Team Mode: Tylko koledzy z dru≈ºyny dajƒÖ podpowiedzi
            let guesser = state.players.find(p => p.id === state.guesserId);
            let teammates = state.players.filter(p => p.team === guesser.team && p.id !== guesser.id);
            needed = teammates.length * state.config.hintsPerUser;
            currentTotal = teammates.reduce((acc, p) => acc + p.hintsGiven, 0);
        }

        if(currentTotal >= needed && needed > 0) {
            if(timerInterval) clearInterval(timerInterval);
            state.phase = 'GUESSING';
            state.viewHintIdx = 0; // Reset widoku
        }
    }

    function forceEndHinting() {
        // Czas minƒÖ≈Ç. Przechodzimy dalej z tym co mamy.
        // Je≈õli nie ma ≈ºadnych podpowiedzi - trudno, zgaduje w ciemno (albo dodajemy pustƒÖ)
        if(state.collectedHints.length === 0) {
            state.collectedHints.push({word: "BRAK CZASU", sender: "SYSTEM", team: null});
        }
        state.phase = 'GUESSING';
        state.viewHintIdx = 0;
        broadcast();
    }

    function calcScore() {
        let guesser = state.players.find(p => p.id === state.guesserId);
        let diff = Math.abs(state.target - state.guess);
        let pts = 0;
        
        if(diff <= 2) pts = 4;
        else if(diff <= 8) pts = 3;
        else if(diff <= 15) pts = 2;
        else if(diff <= 25) pts = 1;

        if(state.config.mode === 'FFA') {
            guesser.score += pts;
        } else {
            state.teams[guesser.team].score += pts;
        }

        state.lastPoints = pts;
        state.phase = 'RESULT';
    }

    function serverNextTurn() {
        state.turnIndex++;
        if(state.turnIndex >= state.players.length) {
            state.turnIndex = 0;
            state.currentRound++;
        }
        
        if(state.currentRound > state.config.rounds) {
            state.phase = 'FINAL';
        } else {
            newTurn();
        }
        broadcast();
    }

    // --- CLIENT LOGIC ---
    function toggleReady() {
        let me = state.players.find(p => p.id === peer.id);
        if(me) myConn.send({type: 'READY', val: !me.ready});
    }

    function selectTeam(t) {
        if(isHost) {
            let me = state.players.find(p=>p.id===peer.id);
            me.team = t;
            broadcast();
        } else {
            myConn.send({type: 'TEAM_CHANGE', val: t});
        }
    }

    function clientSubmitHint() {
        let inp = document.getElementById('hint-input');
        let w = inp.value.trim();
        if(!w) return;
        
        inp.value = ""; // Clear input
        if(isHost) {
            let me = state.players.find(p=>p.id===peer.id);
            state.collectedHints.push({word: w, sender: me.nick, team: me.team});
            me.hintsGiven++;
            checkAllHints();
            broadcast();
        } 
        else {
            myConn.send({type: 'HINT', word: w});
        }
    }

    function clientSubmitGuess() {
        let v = parseInt(document.getElementById('guess-range').value);
        if(isHost) { state.guess = v; calcScore(); broadcast(); }
        else myConn.send({type: 'GUESS', val: v});
    }

    // Lokalna nawigacja po podpowiedziach
    function navHint(dir) {
        let max = state.collectedHints.length - 1;
        state.viewHintIdx += dir;
        if(state.viewHintIdx < 0) state.viewHintIdx = 0;
        if(state.viewHintIdx > max) state.viewHintIdx = max;
        renderGuessingView();
    }

    // --- RENDER ---
    function render() {
        // HEADER & TABELA
        if(state.config.mode === 'TEAM') {
            let nA = state.config.teamNames.A;
            let nB = state.config.teamNames.B;
            document.getElementById('score-header').innerHTML = 
                `<span style="color:var(--team-a)">${nA}: ${state.teams.A.score}</span> | 
                 <span style="color:var(--team-b)">${nB}: ${state.teams.B.score}</span>`;
            
            // Tabela graczy (pokazujemy kto w jakim teamie)
            document.getElementById('score-table').innerHTML = state.players.map(p => {
                let color = p.team === 'A' ? 'var(--team-a)' : 'var(--team-b)';
                return `<div class="score-row" style="border-left: 3px solid ${color}">
                    <span>${p.nick}</span>
                </div>`
            }).join('');

        } else {
            document.getElementById('score-header').innerText = "Top Lista";
            let sorted = [...state.players].sort((a,b)=>b.score-a.score);
            document.getElementById('score-table').innerHTML = sorted.map((p, i) => 
                `<div class="score-row">
                    <span>${i+1}. ${p.nick}</span>
                    <span style="font-weight:bold; color:var(--accent)">${p.score}</span>
                </div>`
            ).join('');
        }
        
        document.getElementById('ui-current-round').innerText = state.currentRound;
        document.getElementById('ui-total-rounds').innerText = state.config.rounds;

        // STATUS
        renderStatus();

        // SCREENS
        if(state.phase === 'LOBBY') renderLobby();
        else if(state.phase === 'HINTING') renderHinting();
        else if(state.phase === 'GUESSING') { showScreen('screen-guessing'); renderGuessingView(); }
        else if(state.phase === 'RESULT') renderResult();
        else if(state.phase === 'FINAL') renderFinal();
    }

    function renderStatus() {
        const list = document.getElementById('status-list');
        if(state.phase === 'HINTING') {
            let guesser = state.players.find(p=>p.id===state.guesserId);
            
            // Kogo pokazujemy w statusie? 
            // W FFA: Wszyscy opr√≥cz guessera.
            // W TEAM: Tylko teammates guessera.
            let activeHinters = state.players.filter(p => {
                if(p.id === guesser.id) return false;
                if(state.config.mode === 'TEAM' && p.team !== guesser.team) return false;
                return true;
            });

            list.innerHTML = activeHinters.map(p => {
                let left = state.config.hintsPerUser - (p.hintsGiven || 0);
                let done = left <= 0;
                return `<div class="status-item ${done?'status-done':'status-pending'}">
                    <span>${p.nick}</span>
                    <span>${done ? 'OK' : 'Pisze ('+left+')'}</span>
                </div>`
            }).join('');
        } 
        else if(state.phase === 'GUESSING') {
            let g = state.players.find(p=>p.id === state.guesserId);
            list.innerHTML = `<div class="status-item status-pending"><span>${g.nick}</span><span>Zgaduje...</span></div>`;
        } 
        else list.innerHTML = "";
    }

    function renderLobby() {
        showScreen('screen-lobby');
        document.getElementById('lobby-mode-info').innerText = 
            state.config.mode === 'FFA' ? "Tryb: Ka≈ºdy na Ka≈ºdego" : "Tryb: Dru≈ºynowy";
        
        document.getElementById('team-selector').style.display = 
            (state.config.mode === 'TEAM' && !isHost) ? 'block' : 'none';
        
        if(state.config.mode === 'TEAM') {
            document.querySelector('.btn-team-a').innerText = "Do≈ÇƒÖcz do: " + state.config.teamNames.A;
            document.querySelector('.btn-team-b').innerText = "Do≈ÇƒÖcz do: " + state.config.teamNames.B;
        }

        const container = document.getElementById('lobby-container');
        if(state.config.mode === 'FFA') {
            container.innerHTML = state.players.map(p => 
                `<div style="background:rgba(0,0,0,0.4); padding:10px 20px; border-radius:50px; border:1px solid ${p.ready?'#2ecc71':'#e74c3c'}">
                    ${p.nick} ${p.isHost ? 'üëë' : ''}
                </div>`
            ).join('');
        } else {
            // Team Columns
            let playersA = state.players.filter(p => p.team === 'A');
            let playersB = state.players.filter(p => p.team === 'B');
            
            // Host buttons for switching team
            let switchBtn = (t) => isHost ? `<button onclick="selectTeam('${t}')" style="font-size:0.6em; padding:2px 8px;">Zmie≈Ñ</button>` : '';

            let colA = `<div class="team-col team-a-bg"><strong>${state.config.teamNames.A}</strong><br>` + 
                playersA.map(p => `<div>${p.nick} ${p.id===peer.id ? '(Ty)' : ''}</div>`).join('') + `
                ${isHost && playersA.find(p=>p.id===peer.id) ? '' : switchBtn('A')}
                </div>`;
            
            let colB = `<div class="team-col team-b-bg"><strong>${state.config.teamNames.B}</strong><br>` + 
                playersB.map(p => `<div>${p.nick} ${p.id===peer.id ? '(Ty)' : ''}</div>`).join('') + `
                ${isHost && playersB.find(p=>p.id===peer.id) ? '' : switchBtn('B')}
                </div>`;
                
            container.innerHTML = colA + colB;
        }

        if(isHost) {
            const canStart = state.players.length >= 2; // Minimalna walidacja
            document.getElementById('btn-start').disabled = !canStart;
            document.getElementById('btn-start').className = canStart ? 'btn-primary' : 'btn-disabled';
        }
    }

    function renderHinting() {
        showScreen('screen-hinting');
        let me = state.players.find(p => p.id === peer.id);
        let guesser = state.players.find(p => p.id === state.guesserId);
        
        // Timer Logic
        let timerDiv = document.getElementById('timer-bar-container');
        let timerTxt = document.getElementById('timer-display');
        if(state.config.timerSeconds > 0) {
            timerDiv.style.display = 'block';
            let pct = (state.timeLeft / state.config.timerSeconds) * 100;
            document.getElementById('timer-bar-fill').style.width = pct + "%";
            timerTxt.innerText = state.timeLeft + "s";
        } else {
            timerDiv.style.display = 'none';
            timerTxt.innerText = "";
        }

        let amIGuesser = (me.id === guesser.id);
        let amIHinter = !amIGuesser;
        if(state.config.mode === 'TEAM' && me.team !== guesser.team) amIHinter = false; // Przeciwna dru≈ºyna tylko patrzy

        if(!amIHinter) {
            document.getElementById('view-guesser-wait').style.display = 'block';
            document.getElementById('view-hinter-active').style.display = 'none';
        } else {
            let left = state.config.hintsPerUser - (me.hintsGiven || 0);
            if(left <= 0) {
                // Skonczyl
                document.getElementById('view-guesser-wait').style.display = 'block';
                document.getElementById('view-guesser-wait').querySelector('h2').innerText = "Gotowe!";
                document.getElementById('view-guesser-wait').querySelector('p').innerText = "Czekaj na innych...";
                document.getElementById('view-hinter-active').style.display = 'none';
            } else {
                // Pisze
                document.getElementById('view-guesser-wait').style.display = 'none';
                document.getElementById('view-hinter-active').style.display = 'block';
                document.getElementById('hint-marker').style.left = state.target + "%";
                document.getElementById('hint-marker-label').innerText = state.target;
                document.getElementById('cat-left').innerText = state.activeCategory[0];
                document.getElementById('cat-right').innerText = state.activeCategory[1];
                
                let currentNr = (me.hintsGiven || 0) + 1;
                document.getElementById('hint-counter-ui').innerText = 
                    `Podpowied≈∫ ${currentNr} z ${state.config.hintsPerUser}`;
            }
        }
    }

    function renderGuessingView() {
        let guesser = state.players.find(p => p.id === state.guesserId);
        
        document.getElementById('ui-guesser-name').innerText = guesser.nick;
        document.getElementById('guess-cat-left').innerText = state.activeCategory[0];
        document.getElementById('guess-cat-right').innerText = state.activeCategory[1];

        // Wy≈õwietlanie aktualnej podpowiedzi z listy
        let hints = state.collectedHints;
        let currentHint = hints[state.viewHintIdx];
        
        if(currentHint) {
            document.getElementById('ui-hint-word').innerText = currentHint.word;
            document.getElementById('ui-hinter-name').innerText = currentHint.sender;
            document.getElementById('ui-hint-index').innerText = `${state.viewHintIdx + 1} / ${hints.length}`;
        }

        let isMeGuesser = peer.id === guesser.id;
        document.getElementById('guesser-controls').style.display = isMeGuesser ? 'block' : 'none';
        document.getElementById('guesser-wait-msg').style.display = isMeGuesser ? 'none' : 'block';
    }

    function renderResult() {
        showScreen('screen-result');
        document.getElementById('res-target-val').innerText = state.target;
        document.getElementById('res-guess-val').innerText = state.guess;
        document.getElementById('res-marker-target').style.left = state.target + "%";
        document.getElementById('res-marker-guess').style.left = state.guess + "%";
        
        let txt = "+" + state.lastPoints + " PKT";
        if(state.lastPoints === 4) txt = "IDEALNIE! +4 PKT";
        else if(state.lastPoints === 0) txt = "PUD≈ÅO! 0 PKT";
        
        document.getElementById('res-points').innerText = txt;
        document.getElementById('host-next-turn').style.display = isHost ? 'block' : 'none';
        document.getElementById('client-wait-msg').style.display = isHost ? 'none' : 'block';
    }

    function renderFinal() {
        showScreen('screen-final');
        let winnerText = "";
        
        if(state.config.mode === 'TEAM') {
            let sA = state.teams.A.score;
            let sB = state.teams.B.score;
            if(sA > sB) winnerText = "üèÜ " + state.config.teamNames.A;
            else if (sB > sA) winnerText = "üèÜ " + state.config.teamNames.B;
            else winnerText = "ü§ù REMIS";
        } else {
            let sorted = [...state.players].sort((a,b)=>b.score-a.score);
            winnerText = "üèÜ " + sorted[0].nick;
        }
        
        document.getElementById('winner-name').innerText = winnerText;
        
        // Ko≈Ñcowa tabela
        if(state.config.mode === 'TEAM') {
             document.getElementById('final-leaderboard').innerHTML = `
                <h3>${state.config.teamNames.A}: ${state.teams.A.score}</h3>
                <h3>${state.config.teamNames.B}: ${state.teams.B.score}</h3>
             `;
        } else {
             let sorted = [...state.players].sort((a,b)=>b.score-a.score);
             document.getElementById('final-leaderboard').innerHTML = sorted.map(p => 
                `<h3>${p.nick}: ${p.score}</h3>`
            ).join('');
        }

        document.getElementById('host-restart').style.display = isHost ? 'block' : 'none';
    }

    function updateGuessMarker(v) {
        document.getElementById('guess-val-display').innerText = v;
        document.getElementById('guess-marker-visual').style.left = v + "%";
    }
</script>
</body>
</html>