<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spektrum</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #2c3e50; color: white; text-align: center; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: #34495e; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        h1 { margin-top: 0; color: #f1c40f; letter-spacing: 2px; }
        h2 { border-bottom: 2px solid #7f8c8d; padding-bottom: 10px; }
        
        .screen { display: none; }
        .active { display: block; }
        
        input[type="text"], input[type="number"], select { padding: 12px; border-radius: 5px; border: none; width: 80%; margin: 10px 0; font-size: 16px; text-align: center;}
        button { padding: 12px 25px; margin: 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: 0.2s; font-weight: bold; }
        
        .btn-primary { background: #27ae60; color: white; }
        .btn-primary:hover { background: #2ecc71; }
        .btn-secondary { background: #e67e22; color: white; }
        .btn-secondary:hover { background: #d35400; }
        .btn-disabled { background: #95a5a6; cursor: not-allowed; }
        .btn-action { background: #3498db; color: white; }

        .player-list { list-style: none; padding: 0; text-align: left; }
        .player-item { background: #ecf0f1; color: #2c3e50; margin: 5px 0; padding: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .status-ready { color: #27ae60; font-weight: bold; }
        .status-wait { color: #e74c3c; font-weight: bold; }
        
        .room-code { font-size: 2em; letter-spacing: 5px; background: #2c3e50; padding: 10px; border: 2px dashed #f1c40f; display: inline-block; margin: 10px 0; color: #f1c40f; }
        #error-msg { color: #ff6b6b; margin-top: 10px; font-weight: bold; min-height: 20px; }

        /* SPECTRUM STYLES */
        .spectrum-wrapper {
            position: relative;
            width: 100%;
            height: 40px;
            background: linear-gradient(to right, #e74c3c 0%, #f1c40f 50%, #3498db 100%);
            border-radius: 20px;
            margin: 40px 0 20px 0;
            border: 3px solid #2c3e50;
        }

        .marker {
            position: absolute;
            width: 6px;
            height: 50px;
            background: white;
            top: -5px;
            border: 2px solid #333;
            border-radius: 5px;
            transform: translateX(-50%);
            transition: left 0.3s ease;
        }

        .marker-label {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            color: #f1c40f;
            font-size: 1.2em;
            text-shadow: 1px 1px 2px black;
        }

        .category-box { background: #2c3e50; padding: 15px; margin: 15px 0; border-radius: 8px; border: 1px solid #7f8c8d; }
        .cat-left { color: #ff6b6b; font-weight: bold; float: left; width: 45%; text-align: left;}
        .cat-right { color: #54a0ff; font-weight: bold; float: right; width: 45%; text-align: right;}
        .clearfix::after { content: ""; clear: both; display: table; }
        
        .hint-word { font-size: 1.8em; color: #f1c40f; margin: 20px 0; text-transform: uppercase; font-weight: 900; }

        /* SLIDER */
        .guess-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 40px;
            background: transparent;
            outline: none;
            cursor: pointer;
            position: absolute;
            top: 0;
            left: 0;
            margin: 0;
            z-index: 10;
        }

        .guess-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 30px;
            height: 30px;
            background: #fff;
            border: 3px solid #2c3e50;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

<div class="container">
    <h1>SPEKTRUM</h1>
    <div id="error-msg"></div>

    <div id="screen-menu" class="screen active">
        <button class="btn-primary" onclick="showScreen('screen-host-setup')">StwÃ³rz GrÄ™</button>
        <button class="btn-secondary" onclick="showScreen('screen-join-setup')">DoÅ‚Ä…cz do Gry</button>
    </div>

    <div id="screen-host-setup" class="screen">
        <h2>Ustawienia</h2>
        <input type="text" id="host-nick" placeholder="TwÃ³j Nick" maxlength="12">
        <br>
        <label>Gracze (2-5):</label>
        <select id="max-players">
            <option value="2">2</option><option value="3">3</option>
            <option value="4">4</option><option value="5">5</option>
        </select><br>
        <button class="btn-secondary" onclick="showScreen('screen-menu')">WrÃ³Ä‡</button>
        <button class="btn-primary" onclick="createGame()">UtwÃ³rz</button>
    </div>

    <div id="screen-join-setup" class="screen">
        <h2>DoÅ‚Ä…cz</h2>
        <input type="text" id="join-nick" placeholder="TwÃ³j Nick" maxlength="12">
        <input type="number" id="join-code" placeholder="4-cyfrowy kod">
        <br>
        <button class="btn-secondary" onclick="showScreen('screen-menu')">WrÃ³Ä‡</button>
        <button class="btn-primary" onclick="joinGame()">DoÅ‚Ä…cz</button>
    </div>

    <div id="screen-lobby" class="screen">
        <h2>Lobby</h2>
        <div id="display-code" class="room-code">----</div>
        <p>Gracze: <span id="player-count">0/0</span></p>
        <ul id="players-list" class="player-list"></ul>
        <div id="controls-host" style="display:none;">
            <button id="btn-start" class="btn-disabled" onclick="startGame()" disabled>Rozpocznij</button>
        </div>
        <div id="controls-client" style="display:none;">
            <button id="btn-ready" class="btn-secondary" onclick="toggleReady()">Gotowy</button>
        </div>
    </div>

    <div id="screen-hinting" class="screen">
        <div id="view-guesser-wait" style="display:none;">
            <h2>JesteÅ› ZgadujÄ…cym!</h2>
            <p>Inni gracze ustalajÄ… podpowiedzi...</p>
            <div style="font-size: 4em;">ðŸ¤«</div>
        </div>

        <div id="view-hinter-active" style="display:none;">
            <h2>Twoja liczba to: <span id="secret-target-text" style="color:#f1c40f">?</span></h2>
            <div class="spectrum-wrapper">
                <div id="hinter-marker" class="marker"><span class="marker-label" id="marker-val">?</span></div>
            </div>
            <div class="category-box clearfix">
                <div class="cat-left" id="cat-left">...</div>
                <div class="cat-right" id="cat-right">...</div>
            </div>
            <input type="text" id="hint-input" placeholder="Wpisz jedno sÅ‚owo...">
            <button class="btn-primary" onclick="submitHint()">WyÅ›lij</button>
        </div>
        
        <div id="view-hinter-done" style="display:none;">
            <h3>WysÅ‚ano!</h3>
            <p>Czekamy na innych...</p>
        </div>
    </div>

    <div id="screen-guessing" class="screen">
        <h2>Zgadywanie</h2>
        <p>Zgaduje: <b id="current-guesser-name"></b></p>
        <div class="category-box clearfix">
            <div class="cat-left" id="guess-cat-left"></div>
            <div class="cat-right" id="guess-cat-right"></div>
        </div>
        <div class="hint-word" id="current-hint-word"></div>
        <p>PodpowiedÅº od: <b id="hinter-name"></b></p>

        <div id="guesser-controls" style="display:none;">
            <button class="btn-action" id="btn-next-hint" onclick="nextHint()">NastÄ™pna podpowiedÅº âž¡</button>
            <div id="final-guess-area" style="display:none;">
                <p>Ostatnia podpowiedÅº! Wybierz liczbÄ™ na pasku:</p>
                <div class="spectrum-wrapper">
                    <input type="range" min="1" max="10" value="5" class="guess-slider" id="guess-range" oninput="updateGuessDisplay(this.value)">
                    <div id="guess-marker-visual" class="marker" style="left: 44.4%; pointer-events: none;">
                        <span class="marker-label" id="guess-val-display">5</span>
                    </div>
                </div>
                <button class="btn-primary" onclick="confirmGuess()">ZGADUJÄ˜!</button>
            </div>
        </div>
        <p id="spectator-msg" style="display:none; color: #bdc3c7;">ZgadujÄ…cy myÅ›li...</p>
    </div>

    <div id="screen-result" class="screen">
        <h2 id="result-title">WYNIK</h2>
        <div style="display: flex; justify-content: space-around; align-items: center;">
            <div><p>Cel</p><div class="room-code" id="result-target">?</div></div>
            <div style="font-size: 2em;">âž”</div>
            <div><p>StrzaÅ‚</p><div class="room-code" id="result-guess">?</div></div>
        </div>
        <div id="result-msg" style="font-size: 1.5em; margin: 20px;"></div>
        <div id="host-restart" style="display:none;"><button class="btn-primary" onclick="restartGame()">Zagraj Ponownie</button></div>
    </div>
</div>

<script>
    const CATEGORIES = [
        ["Tanie", "Drogie"], ["Zdrowe", "Niezdrowe"], ["Najgorszy", "Najlepszy"], ["Nudne", "EkscytujÄ…ce"],
        ["Ciche", "GÅ‚oÅ›ne"], ["Zimne", "GorÄ…ce"], ["Brzydkie", "PiÄ™kne"], ["Bezpieczne", "Niebezpieczne"],
        ["SÅ‚abe", "Silne"], ["MiÄ™kkie", "Twarde"], ["MaÅ‚e", "Wielkie"], ["Wolne", "Szybkie"]
    ];

    const PREFIX = "spektrum-v2-"; 
    let peer = null, myConn = null, hostConns = [], isHost = false, myNick = "", roomCode = "";
    let gameState = { maxPlayers: 0, players: [], phase: 'LOBBY', targetNumber: 5, guesserId: null, currentHintIndex: 0, finalGuess: null };

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function showError(msg) { document.getElementById('error-msg').innerText = msg; setTimeout(()=>document.getElementById('error-msg').innerText="", 3000); }

    // --- HOST ---
    function createGame() {
        const nick = document.getElementById('host-nick').value.trim();
        if (!nick) return showError("Podaj nick!");
        myNick = nick; isHost = true;
        gameState.maxPlayers = parseInt(document.getElementById('max-players').value);
        roomCode = Math.floor(1000 + Math.random() * 9000).toString();
        
        if(peer) peer.destroy();
        peer = new Peer(PREFIX + roomCode);
        document.getElementById('display-code').innerText = "Åadowanie...";

        peer.on('open', (id) => {
            gameState.players = [{ peerId: id, nick: myNick, isReady: false, isHost: true, role: 'HINTER', hintData: null }];
            document.getElementById('display-code').innerText = roomCode;
            setupLobbyUI(); showScreen('screen-lobby');
            peer.on('connection', c => {
                if (gameState.players.length >= gameState.maxPlayers) return c.on('open', ()=> {c.send({type:'ERROR',msg:'PeÅ‚no'}); c.close();});
                hostConns.push(c);
                c.on('data', d => handleData(d, c.peer));
                c.on('close', () => { gameState.players = gameState.players.filter(p=>p.peerId!==c.peer); broadcast(); });
            });
        });
        peer.on('error', e => { if(e.type==='unavailable-id') createGame(); else showError("BÅ‚Ä…d sieci."); });
    }

    // --- JOIN ---
    function joinGame() {
        const nick = document.getElementById('join-nick').value.trim();
        const code = document.getElementById('join-code').value.trim();
        if (!nick || code.length!==4) return showError("BÅ‚Ä™dne dane!");
        myNick = nick; isHost = false;
        if(peer) peer.destroy();
        peer = new Peer();
        peer.on('open', () => {
            myConn = peer.connect(PREFIX + code);
            myConn.on('open', () => {
                showScreen('screen-lobby'); document.getElementById('display-code').innerText = code;
                setupLobbyUI(); myConn.send({type:'JOIN', nick: myNick});
            });
            myConn.on('data', d => { if(d.type==='STATE') { gameState=d.state; render(); } else if(d.type==='ERROR') showError(d.msg); });
            setTimeout(() => { if(!myConn.open) showError("Nie znaleziono pokoju."); }, 4000);
        });
    }

    function handleData(d, peerId) {
        let p = gameState.players.find(x=>x.peerId===peerId);
        if (d.type==='JOIN') { gameState.players.push({peerId, nick:d.nick, isReady:false, isHost:false, role:'HINTER', hintData:null}); }
        else if (d.type==='READY') { if(p) p.isReady = d.val; }
        else if (d.type==='HINT') { if(p && p.hintData) { p.hintData.word=d.word; p.hintData.done=true; checkHints(); } }
        else if (d.type==='NEXT') { if(peerId===gameState.guesserId) gameState.currentHintIndex++; }
        else if (d.type==='GUESS') { if(peerId===gameState.guesserId) { gameState.finalGuess=d.val; gameState.phase='RESULT'; } }
        broadcast();
    }

    function checkHints() {
        const hinters = gameState.players.filter(x=>x.role==='HINTER');
        if (hinters.every(x=>x.hintData && x.hintData.done)) { gameState.phase='GUESSING'; gameState.currentHintIndex=0; }
    }

    function broadcast() { render(); hostConns.forEach(c => c.open && c.send({type:'STATE', state:gameState})); }

    function startGame() {
        gameState.targetNumber = Math.floor(Math.random()*10)+1;
        const idx = Math.floor(Math.random()*gameState.players.length);
        gameState.players.forEach((p,i) => {
            if(i===idx) { p.role='GUESSER'; gameState.guesserId=p.peerId; }
            else { 
                p.role='HINTER'; 
                const cat = CATEGORIES[Math.floor(Math.random()*CATEGORIES.length)];
                p.hintData = { catLeft:cat[0], catRight:cat[1], word:'', done:false };
            }
        });
        gameState.phase = 'HINTING'; broadcast();
    }

    function render() {
        if (gameState.phase==='LOBBY') {
            showScreen('screen-lobby');
            const list = document.getElementById('players-list'); list.innerHTML = "";
            gameState.players.forEach(p => {
                const li = document.createElement('li'); li.className="player-item";
                li.innerHTML = `<span>${p.nick}</span><span class="${p.isReady||p.isHost?'status-ready':'status-wait'}">${p.isHost?'HOST':(p.isReady?'OK':'...')}</span>`;
                list.appendChild(li);
            });
            document.getElementById('player-count').innerText = `${gameState.players.length}/${gameState.maxPlayers}`;
            if(isHost) {
                const canStart = gameState.players.length >= 2 && gameState.players.every(x=>x.isHost || x.isReady);
                document.getElementById('btn-start').disabled = !canStart;
                document.getElementById('btn-start').className = canStart ? 'btn-primary' : 'btn-disabled';
            }
        } else if (gameState.phase==='HINTING') {
            showScreen('screen-hinting');
            const me = gameState.players.find(x=>x.peerId===peer.id);
            if(me.role==='GUESSER') {
                document.getElementById('view-guesser-wait').style.display='block';
                document.getElementById('view-hinter-active').style.display='none';
                document.getElementById('view-hinter-done').style.display='none';
            } else {
                document.getElementById('view-guesser-wait').style.display='none';
                if(me.hintData.done) {
                    document.getElementById('view-hinter-active').style.display='none';
                    document.getElementById('view-hinter-done').style.display='block';
                } else {
                    document.getElementById('view-hinter-active').style.display='block';
                    document.getElementById('view-hinter-done').style.display='none';
                    document.getElementById('secret-target-text').innerText = gameState.targetNumber;
                    document.getElementById('marker-val').innerText = gameState.targetNumber;
                    document.getElementById('hinter-marker').style.left = ((gameState.targetNumber - 1) * 11.11) + "%";
                    document.getElementById('cat-left').innerText = me.hintData.catLeft;
                    document.getElementById('cat-right').innerText = me.hintData.catRight;
                }
            }
        } else if (gameState.phase==='GUESSING') {
            showScreen('screen-guessing');
            const hinters = gameState.players.filter(x=>x.role==='HINTER');
            const h = hinters[gameState.currentHintIndex];
            const me = gameState.players.find(x=>x.peerId===peer.id);
            document.getElementById('current-guesser-name').innerText = gameState.players.find(x=>x.role==='GUESSER').nick;
            document.getElementById('guess-cat-left').innerText = h.hintData.catLeft;
            document.getElementById('guess-cat-right').innerText = h.hintData.catRight;
            document.getElementById('current-hint-word').innerText = h.hintData.word;
            document.getElementById('hinter-name').innerText = h.nick;
            
            const isG = me.role==='GUESSER';
            document.getElementById('guesser-controls').style.display = isG ? 'block' : 'none';
            document.getElementById('spectator-msg').style.display = isG ? 'none' : 'block';
            
            const isLast = gameState.currentHintIndex === hinters.length - 1;
            document.getElementById('btn-next-hint').style.display = (isG && !isLast) ? 'inline-block' : 'none';
            document.getElementById('final-guess-area').style.display = (isG && isLast) ? 'block' : 'none';
        } else if (gameState.phase==='RESULT') {
            showScreen('screen-result');
            document.getElementById('result-target').innerText = gameState.targetNumber;
            document.getElementById('result-guess').innerText = gameState.finalGuess;
            const diff = Math.abs(gameState.targetNumber - gameState.finalGuess);
            const win = diff === 0;
            document.getElementById('result-title').innerText = win ? "IDEALNIE!" : "BLISKO!";
            document.getElementById('result-title').style.color = win ? "#27ae60" : "#e67e22";
            document.getElementById('result-msg').innerText = win ? "ZdobyliÅ›cie 3 punkty!" : (diff <= 1 ? "ZdobyliÅ›cie 1 punkt!" : "0 punktÃ³w.");
            document.getElementById('host-restart').style.display = isHost ? 'block' : 'none';
        }
    }

    function setupLobbyUI() {
        document.getElementById('controls-host').style.display = isHost ? 'block' : 'none';
        document.getElementById('controls-client').style.display = isHost ? 'none' : 'block';
    }

    function toggleReady() {
        const me = gameState.players.find(x=>x.peerId===peer.id);
        const val = !me.isReady;
        myConn.send({type:'READY', val});
    }

    function submitHint() {
        const word = document.getElementById('hint-input').value.trim();
        if(!word) return;
        if(isHost) { 
            const me = gameState.players.find(x=>x.peerId===peer.id);
            me.hintData.word=word; me.hintData.done=true; checkHints(); broadcast();
        } else myConn.send({type:'HINT', word});
    }

    function nextHint() { if(isHost) { gameState.currentHintIndex++; broadcast(); } else myConn.send({type:'NEXT'}); }

    function updateGuessDisplay(v) {
        document.getElementById('guess-val-display').innerText = v;
        document.getElementById('guess-marker-visual').style.left = ((v-1)*11.11) + "%";
    }

    function confirmGuess() {
        const val = parseInt(document.getElementById('guess-range').value);
        if(isHost) { gameState.finalGuess=val; gameState.phase='RESULT'; broadcast(); }
        else myConn.send({type:'GUESS', val});
    }

    function restartGame() { if(isHost) { gameState.phase='LOBBY'; gameState.players.forEach(p=>p.isReady=false); broadcast(); } }
</script>
</body>
</html>