<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spektrum</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00f260;
            --secondary: #0575e6;
            --accent: #f5af19;
            --glass: rgba(0, 0, 0, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text: #ffffff;
        }

        body {
            font-family: 'Poppins', sans-serif;
            /* Ciemniejszy background */
            background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e, #000000);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--text);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            /* Mocny cie≈Ñ pod tekstem (efekt obrysu) */
            text-shadow: 2px 2px 0px #000000, 0 0 10px rgba(0,0,0,0.8);
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- LAYOUT --- */
        .sidebar {
            width: 250px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--glass-border);
            transition: 0.3s;
        }
        
        .sidebar-right {
            border-right: none;
            border-left: 1px solid var(--glass-border);
        }

        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .game-card {
            width: 100%;
            max-width: 700px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            text-align: center;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- TYPOGRAPHY & UI --- */
        h1 { font-weight: 900; letter-spacing: 3px; margin-bottom: 5px; color: var(--accent); }
        h2 { font-weight: 700; color: #fff; margin-bottom: 20px; }
        h3 { font-weight: 400; margin: 10px 0; }

        .screen { display: none; }
        .active { display: block; animation: fadeIn 0.5s; }

        button {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 700;
            font-family: 'Poppins', sans-serif;
            margin: 10px;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            color: white;
            text-shadow: 1px 1px 2px black;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-primary { background: linear-gradient(45deg, #00b09b, #96c93d); }
        .btn-primary:hover { transform: scale(1.05); filter: brightness(1.2); }
        
        .btn-secondary { background: linear-gradient(45deg, #FF416C, #FF4B2B); }
        .btn-secondary:hover { transform: scale(1.05); filter: brightness(1.2); }

        .btn-disabled { background: #555; cursor: not-allowed; opacity: 0.6; filter: grayscale(1); }

        /* Poprawka INPUT i SELECT */
        input[type="text"], input[type="number"] {
            padding: 15px;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(0,0,0,0.5);
            color: white;
            font-size: 1.1em;
            width: 70%;
            text-align: center;
            outline: none;
            font-family: 'Poppins', sans-serif;
        }

        /* Tutaj naprawa widoczno≈õci tekstu w SELECT */
        select {
            padding: 15px;
            border-radius: 12px;
            border: 2px solid var(--accent);
            background: #fff; /* Bia≈Çe t≈Ço */
            color: #000; /* Czarny tekst */
            font-size: 1.1em;
            width: 75%;
            text-align: center;
            outline: none;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            font-weight: bold;
            text-shadow: none; /* Bez cienia w ≈õrodku selecta */
        }
        option { background: #fff; color: #000; }

        /* --- SPECTRUM BAR --- */
        .spectrum-wrapper {
            position: relative;
            width: 100%;
            height: 50px;
            /* Ciemniejsze, bardziej neonowe kolory paska */
            background: linear-gradient(90deg, #ff0055 0%, #ffcc00 50%, #00ccff 100%);
            border-radius: 25px;
            margin: 40px 0 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5), inset 0 3px 10px rgba(0,0,0,0.3);
            border: 3px solid rgba(255,255,255,0.1);
        }

        .marker {
            position: absolute;
            width: 6px;
            height: 60px;
            background: #fff;
            top: -8px;
            border: 2px solid #000;
            border-radius: 4px;
            transform: translateX(-50%);
            transition: left 0.4s cubic-bezier(0.22, 1, 0.36, 1);
            z-index: 2;
            pointer-events: none; /* Znacznik jest wizualny, nie klika siƒô go */
        }

        .marker-label {
            position: absolute;
            top: -45px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 900;
            color: #fff;
            background: #000;
            padding: 5px 12px;
            border-radius: 8px;
            border: 1px solid var(--accent);
            white-space: nowrap;
        }

        /* --- SLIDER FIX (Niewidzialny) --- */
        .guess-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 50px; /* Taka sama wysoko≈õƒá jak pasek */
            background: transparent;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
            cursor: pointer;
            margin: 0;
            opacity: 0; /* To sprawia, ≈ºe suwak jest niewidoczny, ale dzia≈Ça! */
        }
        /* Dla pewno≈õci usuwamy stylizacjƒô thumba, choƒá opacity 0 i tak to ukrywa */
        .guess-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 50px; height: 50px; background: red; }

        .category-box {
            background: rgba(0,0,0,0.6);
            padding: 20px;
            margin: 20px 0;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            font-weight: 700;
            font-size: 1.1em;
            text-transform: uppercase;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .score-row {
            display: flex; justify-content: space-between; padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 1.1em;
        }
        
        .status-item {
            padding: 10px; margin: 8px 0; border-radius: 8px; font-size: 0.9em;
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
        }
        .status-done { color: #2ecc71; border-color: #2ecc71; }
        .status-pending { color: #e74c3c; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        .room-code { font-size: 3em; font-weight: 900; letter-spacing: 5px; color: var(--accent); margin: 20px 0; }
        #error-msg { color: #ff4757; font-weight: bold; min-height: 20px; text-shadow: none; background: rgba(0,0,0,0.5); display: inline-block; padding: 0 10px; border-radius: 5px;}

        @media (max-width: 800px) {
            body { flex-direction: column; overflow-y: scroll; height: auto; }
            .sidebar { width: 100%; height: auto; padding: 10px; order: 2; }
            .main-content { padding: 10px; order: 1; min-height: 80vh; }
            .category-box { flex-direction: column; gap: 10px; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>üèÜ Tabela</h2>
        <div id="score-table"></div>
        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <p>Runda: <span id="ui-current-round" style="color:var(--accent);">0</span> / <span id="ui-total-rounds">0</span></p>
        </div>
    </div>

    <div class="main-content">
        <div class="game-card">
            <h1>SPEKTRUM</h1>
            <div id="error-msg"></div>

            <div id="screen-menu" class="screen active">
                <button class="btn-primary" onclick="showScreen('screen-host-setup')">Nowa Gra</button>
                <button class="btn-secondary" onclick="showScreen('screen-join-setup')">Do≈ÇƒÖcz</button>
            </div>

            <div id="screen-host-setup" class="screen">
                <h2>Konfiguracja</h2>
                <input type="text" id="host-nick" placeholder="Tw√≥j Nick" maxlength="15">
                <br><br>
                <label>Liczba rund:</label><br>
                <select id="total-rounds">
                    <option value="2">2 Rundy (Szybka)</option>
                    <option value="3" selected>3 Rundy (Standard)</option>
                    <option value="5">5 Rund (D≈Çuga)</option>
                </select>
                <br><br>
                <button class="btn-secondary" onclick="showScreen('screen-menu')">Wr√≥ƒá</button>
                <button class="btn-primary" onclick="createGame()">Utw√≥rz Lobby</button>
            </div>

            <div id="screen-join-setup" class="screen">
                <h2>Do≈ÇƒÖczanie</h2>
                <input type="text" id="join-nick" placeholder="Tw√≥j Nick" maxlength="15">
                <input type="number" id="join-code" placeholder="4-cyfrowy kod">
                <br><br>
                <button class="btn-secondary" onclick="showScreen('screen-menu')">Wr√≥ƒá</button>
                <button class="btn-primary" onclick="joinGame()">Do≈ÇƒÖcz</button>
            </div>

            <div id="screen-lobby" class="screen">
                <h3>KOD POKOJU:</h3>
                <div id="display-code" class="room-code">...</div>
                <p>GRACZE W LOBBY:</p>
                <div id="lobby-list" style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px;"></div>
                
                <div id="controls-host" style="display:none; margin-top:30px;">
                    <button id="btn-start" class="btn-disabled" onclick="serverStartGame()" disabled>Rozpocznij Grƒô</button>
                </div>
                <div id="controls-client" style="display:none; margin-top:30px;">
                    <button id="btn-ready" class="btn-secondary" onclick="toggleReady()">Zg≈Ço≈õ Gotowo≈õƒá</button>
                </div>
            </div>

            <div id="screen-hinting" class="screen">
                <div id="view-guesser-wait">
                    <h2>Jeste≈õ ZgadujƒÖcym!</h2>
                    <p style="opacity:0.8">Poczekaj, a≈º Twoja dru≈ºyna wymy≈õli podpowied≈∫.</p>
                    <div style="font-size: 4em; animation: pulse 2s infinite;">ü§´</div>
                </div>

                <div id="view-hinter-active" style="display:none;">
                    <h3>TWOJA TAJNA LICZBA</h3>
                    <div class="spectrum-wrapper">
                        <div id="hint-marker" class="marker"><span class="marker-label" id="hint-marker-label">?</span></div>
                    </div>
                    
                    <p>KATEGORIA:</p>
                    <div class="category-box">
                        <span id="cat-left" style="color:#ff4757">...</span>
                        <span id="cat-right" style="color:#00ccff">...</span>
                    </div>

                    <input type="text" id="hint-input" placeholder="Wpisz s≈Çowo...">
                    <br><br>
                    <button class="btn-primary" onclick="clientSubmitHint()">Wy≈õlij</button>
                </div>
            </div>

            <div id="screen-guessing" class="screen">
                <p>ZGADUJE: <b id="ui-guesser-name" style="color:var(--accent);"></b></p>
                
                <div class="category-box">
                    <span id="guess-cat-left" style="color:#ff4757"></span>
                    <span id="guess-cat-right" style="color:#00ccff"></span>
                </div>

                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin: 20px 0; border: 1px solid var(--accent);">
                    <p style="margin:0; font-size:0.7em; text-transform:uppercase;">Podpowied≈∫ od: <span id="ui-hinter-name"></span></p>
                    <div id="ui-hint-word" style="font-size: 2.2em; font-weight: 900; color: var(--accent); text-transform: uppercase; margin-top:5px;"></div>
                </div>

                <div id="guesser-controls" style="display:none;">
                    <button id="btn-next" class="btn-secondary" onclick="clientRequestNext()">Nastƒôpna ‚û°</button>
                    
                    <div id="final-guess-ui" style="display:none;">
                        <p>PRZESU≈É SUWAK I STRZELAJ!</p>
                        <div class="spectrum-wrapper">
                            <input type="range" min="1" max="100" value="50" class="guess-slider" id="guess-range" oninput="updateGuessMarker(this.value)">
                            
                            <div id="guess-marker-visual" class="marker" style="left: 50%;">
                                <span class="marker-label" id="guess-val-display">50</span>
                            </div>
                        </div>
                        <br>
                        <button class="btn-primary" onclick="clientSubmitGuess()">ZGADUJƒò!</button>
                    </div>
                </div>
            </div>

            <div id="screen-result" class="screen">
                <h2 id="res-title" style="font-size: 2.5em; text-transform: uppercase;">WYNIK</h2>
                
                <div class="spectrum-wrapper" style="margin-bottom: 60px;">
                    <div id="res-marker-target" class="marker" style="background:var(--accent); z-index:1; border-color:white;">
                        <span class="marker-label" style="background:var(--accent); color:black;">CEL</span>
                    </div>
                    <div id="res-marker-guess" class="marker" style="background:#fff; z-index:2; top:10px; height:40px;">
                        <span class="marker-label" style="top:40px; background:#fff; color:black;">TY</span>
                    </div>
                </div>

                <div style="display: flex; justify-content: center; gap: 40px; font-size: 1.5em; margin-bottom: 20px;">
                    <div>Cel: <b id="res-target-val" style="color:var(--accent)"></b></div>
                    <div>Strza≈Ç: <b id="res-guess-val"></b></div>
                </div>

                <div id="res-points" style="font-size: 2.5em; color: var(--primary); font-weight:900;"></div>

                <div id="host-next-turn" style="display:none;">
                    <button class="btn-primary" onclick="serverNextTurn()">Dalej ‚û°</button>
                </div>
                <p id="client-wait-msg" style="display:none; opacity:0.7;">Oczekiwanie na lidera...</p>
            </div>

            <div id="screen-final" class="screen">
                <h1 style="font-size: 3em; color: var(--accent);">KONIEC</h1>
                <h2 id="winner-name"></h2>
                <div id="final-leaderboard" style="margin: 30px 0;"></div>
                <div id="host-restart" style="display:none;">
                    <button class="btn-primary" onclick="location.reload()">Zagraj Ponownie</button>
                </div>
            </div>

        </div>
    </div>

    <div class="sidebar sidebar-right">
        <h2>üí¨ Status</h2>
        <div id="status-list"></div>
    </div>

<script>
    const CATS = [
        ["Najgorszy dodatek do pizzy", "Najlepszy dodatek do pizzy"],
        ["Tani prezent ≈õlubny", "Drogi prezent ≈õlubny"],
        ["Film, na kt√≥rym za≈õniesz", "Film, kt√≥ry zmieni twoje ≈ºycie"],
        ["Rzecz, kt√≥rƒÖ zgubisz raz w ≈ºyciu", "Rzecz, kt√≥rƒÖ gubisz codziennie"],
        ["Bezu≈ºyteczna supermoc", "Niezbƒôdna supermoc"],
        ["Aktor z jednej roli", "Legenda kina"],
        ["Piosenka do windy", "Hymn stadionu"],
        ["Nudne zwierzƒô domowe", "EkscytujƒÖce zwierzƒô domowe"],
        ["Jedzenie, kt√≥re brudzi rƒôce", "Jedzenie idealne na randkƒô"],
        ["Bezpieczne hobby", "≈ömiertelnie niebezpieczne hobby"],
        ["Imiƒô dla grzecznego dziecka", "Imiƒô dla ≈Çobuza"],
        ["Praca dla introwertyka", "Praca dla ekstrawertyka"],
        ["Co≈õ, co trzymasz w kieszeni", "Co≈õ, co trzymasz w sejfie"],
        ["Zapach ze stacji benzynowej", "Zapach perfumerii"],
        ["Najgorsze miejsce na o≈õwiadczyny", "Idealne miejsce na o≈õwiadczyny"],
        ["Gra, kt√≥ra siƒô nudzi po 5 minutach", "Gra na tysiƒÖce godzin"],
        ["Tani samoch√≥d", "Luksusowy jacht"],
        ["Plotka", "Fakt naukowy"],
        ["Co≈õ miƒôkkiego", "Co≈õ twardszego od diamentu"],
        ["Bohater z bajki", "Postaƒá z horroru"],
        ["MƒÖdra inwestycja", "Wyrzucanie pieniƒôdzy w b≈Çoto"],
        ["≈Åatwy przedmiot w szkole", "Koszmar studenta"],
        ["Lekka przekƒÖska", "Obiad u babci"],
        ["Miejsce ciche jak biblioteka", "Miejsce g≈Ço≈õne jak start rakiety"],
        ["Legalne", "Do≈ºywocie"],
        ["Zdrowe ≈õniadanie", "Zawa≈Ç serca na talerzu"],
        ["Serial dla nastolatk√≥w", "Dokument historyczny"],
        ["Ubranie na si≈Çowniƒô", "Ubranie na galƒô OscarowƒÖ"],
        ["S≈Çaby tekst na podryw", "Mistrzowski flirt"],
        ["Co≈õ, co szybko gnije", "Co≈õ, co przetrwa wieki"],
        ["Wstydliwa przyjemno≈õƒá", "Pow√≥d do dumy"],
        ["Najgorszy spos√≥b na ≈õmierƒá", "Bohaterska ≈õmierƒá"],
        ["Zimne jak l√≥d", "GorƒÖce jak s≈Ço≈Ñce"],
        ["Kr√≥tkotrwa≈Ça moda", "Ponadczasowy styl"],
        ["Zwierzƒô, kt√≥re chcesz przytuliƒá", "Zwierzƒô, przed kt√≥rym uciekasz"],
        ["Najgorszy smak lod√≥w", "Najlepszy smak lod√≥w"]
    ];

    const PREFIX = "spektrum-dark-";
    let peer, myConn, hostConns = [], isHost = false, myNick = "";
    
    let state = {
        phase: 'LOBBY',
        players: [],
        totalRounds: 3,
        currentRound: 1,
        turnIndex: 0, 
        target: 50,
        guess: 50,
        hintIdx: 0,
        lastPoints: 0
    };

    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function error(m) { document.getElementById('error-msg').innerText = m; setTimeout(()=>document.getElementById('error-msg').innerText="", 3000); }

    // --- SETUP ---
    function createGame() {
        myNick = document.getElementById('host-nick').value.trim();
        if(!myNick) return error("Podaj nick!");
        state.totalRounds = parseInt(document.getElementById('total-rounds').value);
        let code = Math.floor(1000 + Math.random()*9000).toString();
        isHost = true;
        
        if(peer) peer.destroy();
        peer = new Peer(PREFIX + code);
        
        peer.on('open', id => {
            state.players = [{id, nick: myNick, score: 0, ready: true, isHost: true}];
            document.getElementById('display-code').innerText = code;
            document.getElementById('controls-host').style.display = 'block';
            showScreen('screen-lobby'); render();
            
            peer.on('connection', c => {
                hostConns.push(c);
                c.on('data', d => handleServerData(d, c));
                c.on('close', () => { 
                    state.players = state.players.filter(p => p.id !== c.peer);
                    broadcast();
                });
            });
        });
        peer.on('error', () => createGame());
    }

    function joinGame() {
        myNick = document.getElementById('join-nick').value.trim();
        let code = document.getElementById('join-code').value.trim();
        if(!myNick || code.length !== 4) return error("B≈Çƒôdne dane!");
        
        if(peer) peer.destroy();
        peer = new Peer();
        
        peer.on('open', () => {
            myConn = peer.connect(PREFIX + code);
            myConn.on('open', () => {
                myConn.send({type: 'JOIN', nick: myNick});
                document.getElementById('display-code').innerText = code;
                document.getElementById('controls-client').style.display = 'block';
                showScreen('screen-lobby');
            });
            myConn.on('data', d => { state = d; render(); });
            setTimeout(()=>{ if(!myConn.open) error("Nie znaleziono pokoju"); }, 3000);
        });
    }

    // --- HOST LOGIC ---
    function handleServerData(d, conn) {
        let p = state.players.find(x => x.id === conn.peer);
        if(!p && d.type === 'JOIN') {
            state.players.push({id: conn.peer, nick: d.nick, score: 0, ready: false, isHost: false});
        }
        else if(p) {
            if(d.type === 'READY') p.ready = d.val;
            if(d.type === 'HINT') { p.word = d.word; p.hintDone = true; checkAllHints(); }
            if(d.type === 'NEXT') state.hintIdx++;
            if(d.type === 'GUESS') { state.guess = d.val; calcScore(); }
        }
        broadcast();
    }

    function broadcast() { render(); hostConns.forEach(c => c.open && c.send(state)); }

    function serverStartGame() {
        state.currentRound = 1;
        state.turnIndex = 0;
        newTurn();
    }

    function newTurn() {
        state.phase = 'HINTING';
        state.target = Math.floor(Math.random()*100) + 1;
        state.hintIdx = 0;
        state.players.forEach((p, i) => {
            p.hintDone = false;
            if(i === state.turnIndex) p.role = 'GUESSER';
            else {
                p.role = 'HINTER';
                p.cat = CATS[Math.floor(Math.random()*CATS.length)];
            }
        });
        broadcast();
    }

    function checkAllHints() {
        if(state.players.filter(p => p.role === 'HINTER' && !p.hintDone).length === 0) {
            state.phase = 'GUESSING';
        }
    }

    function calcScore() {
        let guesser = state.players[state.turnIndex];
        let diff = Math.abs(state.target - state.guess);
        let pts = 0;
        if(diff <= 1) pts = 7;
        else if(diff <= 5) pts = 5;
        else if(diff <= 10) pts = 4;
        else if(diff <= 15) pts = 3;
        else if(diff <= 25) pts = 1;

        guesser.score += pts;
        state.lastPoints = pts;
        state.phase = 'RESULT';
    }

    function serverNextTurn() {
        state.turnIndex++;
        if(state.turnIndex >= state.players.length) {
            state.turnIndex = 0;
            state.currentRound++;
        }
        if(state.currentRound > state.totalRounds) {
            state.phase = 'FINAL';
        } else {
            newTurn();
        }
        broadcast();
    }

    // --- CLIENT LOGIC ---
    function toggleReady() {
        let me = state.players.find(p => p.id === peer.id);
        if(me) myConn.send({type: 'READY', val: !me.ready});
    }
    function clientSubmitHint() {
        let w = document.getElementById('hint-input').value.trim();
        if(!w) return;
        if(isHost) handleServerData({type:'HINT', word: w}, {peer: peer.id}); 
        else myConn.send({type: 'HINT', word: w});
    }
    function clientRequestNext() {
        if(isHost) handleServerData({type: 'NEXT'}, {peer: peer.id});
        else myConn.send({type: 'NEXT'});
    }
    function clientSubmitGuess() {
        let v = parseInt(document.getElementById('guess-range').value);
        if(isHost) handleServerData({type: 'GUESS', val: v}, {peer: peer.id});
        else myConn.send({type: 'GUESS', val: v});
    }

    // --- RENDER ---
    function render() {
        // Tabela wynik√≥w
        const sorted = [...state.players].sort((a,b)=>b.score-a.score);
        document.getElementById('score-table').innerHTML = sorted.map((p, i) => 
            `<div class="score-row">
                <span>${i+1}. ${p.nick} ${p.role === 'GUESSER' && state.phase !== 'FINAL' ? 'üß†' : ''}</span>
                <span style="font-weight:bold; color:var(--accent)">${p.score}</span>
            </div>`
        ).join('');
        
        document.getElementById('ui-current-round').innerText = state.currentRound;
        document.getElementById('ui-total-rounds').innerText = state.totalRounds;

        // Statusy
        const statusList = document.getElementById('status-list');
        if(state.phase === 'HINTING') {
            statusList.innerHTML = state.players.filter(p=>p.role==='HINTER').map(p => 
                `<div class="status-item ${p.hintDone?'status-done':'status-pending'}">
                    <span>${p.nick}</span>
                    <span>${p.hintDone?'GOTOWY':'My≈õli...'}</span>
                </div>`
            ).join('');
        } else if(state.phase === 'GUESSING') {
            let g = state.players.find(p=>p.role==='GUESSER');
            statusList.innerHTML = `<div class="status-item status-pending"><span>${g.nick}</span><span>Zgaduje...</span></div>`;
        } else {
            statusList.innerHTML = "";
        }

        // Fazy
        if(state.phase === 'LOBBY') {
            showScreen('screen-lobby');
            document.getElementById('lobby-list').innerHTML = state.players.map(p => 
                `<div style="background:rgba(0,0,0,0.4); padding:10px 20px; border-radius:50px; border:1px solid ${p.ready?'#2ecc71':'#e74c3c'}">
                    ${p.nick} ${p.isHost ? 'üëë' : ''} ${p.ready ? '‚úÖ' : '‚è≥'}
                </div>`
            ).join('');
            
            if(isHost) {
                const canStart = state.players.length >= 2 && state.players.every(p => p.ready || p.isHost);
                document.getElementById('btn-start').disabled = !canStart;
                document.getElementById('btn-start').className = canStart ? 'btn-primary' : 'btn-disabled';
            }
        }
        else if(state.phase === 'HINTING') {
            showScreen('screen-hinting');
            let me = state.players.find(p => p.id === peer.id);
            if(me.role === 'GUESSER') {
                document.getElementById('view-guesser-wait').style.display = 'block';
                document.getElementById('view-hinter-active').style.display = 'none';
            } else {
                document.getElementById('view-guesser-wait').style.display = 'none';
                document.getElementById('view-hinter-active').style.display = me.hintDone ? 'none' : 'block';
                if(!me.hintDone) {
                    document.getElementById('hint-marker').style.left = state.target + "%";
                    document.getElementById('hint-marker-label').innerText = state.target;
                    document.getElementById('cat-left').innerText = me.cat[0];
                    document.getElementById('cat-right').innerText = me.cat[1];
                }
            }
        }
        else if(state.phase === 'GUESSING') {
            showScreen('screen-guessing');
            let guesser = state.players[state.turnIndex];
            let hinters = state.players.filter(p => p.role === 'HINTER');
            let h = hinters[state.hintIdx];
            
            document.getElementById('ui-guesser-name').innerText = guesser.nick;
            document.getElementById('ui-hinter-name').innerText = h.nick;
            document.getElementById('ui-hint-word').innerText = h.word;
            document.getElementById('guess-cat-left').innerText = h.cat[0];
            document.getElementById('guess-cat-right').innerText = h.cat[1];

            let isMeGuesser = peer.id === guesser.id;
            document.getElementById('guesser-controls').style.display = isMeGuesser ? 'block' : 'none';
            
            let isLastHint = state.hintIdx === hinters.length - 1;
            document.getElementById('btn-next').style.display = (isMeGuesser && !isLastHint) ? 'inline-block' : 'none';
            document.getElementById('final-guess-ui').style.display = (isMeGuesser && isLastHint) ? 'block' : 'none';
        }
        else if(state.phase === 'RESULT') {
            showScreen('screen-result');
            document.getElementById('res-target-val').innerText = state.target;
            document.getElementById('res-guess-val').innerText = state.guess;
            document.getElementById('res-marker-target').style.left = state.target + "%";
            document.getElementById('res-marker-guess').style.left = state.guess + "%";
            
            let txt = "+" + state.lastPoints + " PKT";
            if(state.lastPoints === 4) txt = "IDEALNIE! +4 PKT";
            else if(state.lastPoints === 0) txt = "PUD≈ÅO! 0 PKT";
            
            document.getElementById('res-points').innerText = txt;
            document.getElementById('host-next-turn').style.display = isHost ? 'block' : 'none';
            document.getElementById('client-wait-msg').style.display = isHost ? 'none' : 'block';
        }
        else if(state.phase === 'FINAL') {
            showScreen('screen-final');
            let winner = sorted[0];
            document.getElementById('winner-name').innerText = "üèÜ " + winner.nick + " üèÜ";
            document.getElementById('final-leaderboard').innerHTML = sorted.map(p => 
                `<h3>${p.nick}: ${p.score}</h3>`
            ).join('');
            document.getElementById('host-restart').style.display = isHost ? 'block' : 'none';
        }
    }

    function updateGuessMarker(v) {
        document.getElementById('guess-val-display').innerText = v;
        document.getElementById('guess-marker-visual').style.left = v + "%";
    }
</script>
</body>
</html>