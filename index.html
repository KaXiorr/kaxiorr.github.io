<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spektrum PRO - Multiplayer</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #27ae60; --secondary: #e67e22; --bg: #2c3e50; --panel: #34495e; --text: #ecf0f1; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* Layout */
        .sidebar { width: 200px; background: rgba(0,0,0,0.2); padding: 15px; display: flex; flex-direction: column; border-right: 1px solid #444; }
        .sidebar-right { border-right: none; border-left: 1px solid #444; }
        .main-content { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }
        
        .container { width: 100%; max-width: 600px; background: var(--panel); padding: 25px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.4); text-align: center; }

        /* UI Elements */
        h1 { color: #f1c40f; margin-top: 0; letter-spacing: 2px; }
        .screen { display: none; }
        .active { display: block; }
        
        button { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin: 5px; transition: 0.3s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-disabled { background: #7f8c8d; cursor: not-allowed; }
        
        input, select { padding: 10px; border-radius: 4px; border: none; margin: 10px 0; width: 80%; }

        /* Tables & Lists */
        .score-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #555; font-size: 0.9em; }
        .status-item { padding: 8px; margin: 4px 0; border-radius: 4px; font-size: 0.85em; }
        .status-done { background: rgba(39, 174, 96, 0.3); color: #2ecc71; }
        .status-pending { background: rgba(231, 76, 60, 0.3); color: #e74c3c; }

        /* Spectrum Components */
        .spectrum-wrapper { position: relative; width: 100%; height: 40px; background: linear-gradient(to right, #e74c3c, #f1c40f, #3498db); border-radius: 20px; margin: 35px 0 15px; border: 3px solid #222; }
        .marker { position: absolute; width: 6px; height: 50px; background: white; top: -5px; border: 2px solid #222; border-radius: 4px; transform: translateX(-50%); transition: left 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .marker-label { position: absolute; top: -35px; left: 50%; transform: translateX(-50%); font-weight: bold; color: #f1c40f; }
        .guess-slider { -webkit-appearance: none; width: 100%; height: 40px; background: transparent; position: absolute; top: 0; left: 0; z-index: 5; cursor: pointer; }
        .guess-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 30px; height: 30px; background: white; border-radius: 50%; border: 2px solid #333; }

        .category-box { background: #2c3e50; padding: 15px; margin: 15px 0; border-radius: 8px; display: flex; justify-content: space-between; font-weight: bold; }
        .room-code { font-size: 1.5em; color: #f1c40f; border: 2px dashed #f1c40f; padding: 10px; display: inline-block; margin: 10px; }
        #error-msg { color: #ff6b6b; font-weight: bold; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h3>üèÜ Wyniki</h3>
        <div id="score-table">
            </div>
        <div style="margin-top: auto; font-size: 0.8em; opacity: 0.7;">
            Runda: <span id="ui-current-round">0</span>/<span id="ui-total-rounds">0</span>
        </div>
    </div>

    <div class="main-content">
        <div class="container">
            <h1>SPEKTRUM</h1>
            <div id="error-msg"></div>

            <div id="screen-menu" class="screen active">
                <button class="btn-primary" onclick="showScreen('screen-host-setup')">Stw√≥rz Grƒô</button>
                <button class="btn-secondary" onclick="showScreen('screen-join-setup')">Do≈ÇƒÖcz</button>
            </div>

            <div id="screen-host-setup" class="screen">
                <h2>Ustawienia Hostera</h2>
                <input type="text" id="host-nick" placeholder="Tw√≥j Nick">
                <br>
                <label>Ilo≈õƒá graczy: </label>
                <select id="max-players"><option>2</option><option>3</option><option>4</option><option>5</option></select>
                <br>
                <label>Ilo≈õƒá rund: </label>
                <select id="total-rounds"><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select>
                <br>
                <button class="btn-primary" onclick="createGame()">Utw√≥rz Lobby</button>
            </div>

            <div id="screen-join-setup" class="screen">
                <h2>Do≈ÇƒÖcz do Gry</h2>
                <input type="text" id="join-nick" placeholder="Tw√≥j Nick">
                <input type="number" id="join-code" placeholder="4-cyfrowy kod">
                <br>
                <button class="btn-primary" onclick="joinGame()">Po≈ÇƒÖcz</button>
            </div>

            <div id="screen-lobby" class="screen">
                <h2>Lobby</h2>
                <div id="display-code" class="room-code">----</div>
                <div id="lobby-list" style="text-align: left; margin: 20px 0;"></div>
                <div id="controls-host" style="display:none;">
                    <button id="btn-start" class="btn-disabled" onclick="serverStartGame()" disabled>Start Gry</button>
                </div>
                <div id="controls-client" style="display:none;">
                    <button id="btn-ready" class="btn-secondary" onclick="toggleReady()">Jestem Gotowy</button>
                </div>
            </div>

            <div id="screen-hinting" class="screen">
                <div id="view-guesser-wait">
                    <h3>Jeste≈õ ZgadujƒÖcym!</h3>
                    <p>Inni przygotowujƒÖ podpowiedzi dla Ciebie.</p>
                    <div style="font-size: 3em;">ü§´</div>
                </div>
                <div id="view-hinter-active" style="display:none;">
                    <h3>Twoja liczba: <span id="hint-target-val" style="color:#f1c40f">?</span></h3>
                    <div class="spectrum-wrapper">
                        <div id="hint-marker" class="marker"><span class="marker-label" id="hint-marker-label">?</span></div>
                    </div>
                    <div class="category-box">
                        <span id="cat-left" style="color:#ff6b6b"></span>
                        <span id="cat-right" style="color:#3498db"></span>
                    </div>
                    <input type="text" id="hint-input" placeholder="Wpisz s≈Çowo-klucz...">
                    <button class="btn-primary" onclick="clientSubmitHint()">Wy≈õlij podpowied≈∫</button>
                </div>
            </div>

            <div id="screen-guessing" class="screen">
                <h3>Zgaduje: <span id="ui-guesser-name" style="color:#f1c40f"></span></h3>
                <div class="category-box">
                    <span id="guess-cat-left" style="color:#ff6b6b"></span>
                    <span id="guess-cat-right" style="color:#3498db"></span>
                </div>
                <div id="ui-hint-word" style="font-size: 2em; font-weight: 900; margin: 20px 0; text-transform: uppercase;"></div>
                <p>Podpowiada: <span id="ui-hinter-name"></span></p>
                
                <div id="guesser-controls" style="display:none;">
                    <button id="btn-next" class="btn-secondary" onclick="clientRequestNext()">Nastƒôpna podpowied≈∫ ‚û°</button>
                    <div id="final-guess-ui" style="display:none;">
                        <p>Ostatnia podpowied≈∫! Wybierz liczbƒô na pasku:</p>
                        <div class="spectrum-wrapper">
                            <input type="range" min="1" max="10" value="5" class="guess-slider" id="guess-range" oninput="updateGuessMarker(this.value)">
                            <div id="guess-marker-visual" class="marker" style="left: 44.4%; pointer-events: none;">
                                <span class="marker-label" id="guess-val-display">5</span>
                            </div>
                        </div>
                        <button class="btn-primary" onclick="clientSubmitGuess()">ZGADUJƒò!</button>
                    </div>
                </div>
            </div>

            <div id="screen-result" class="screen">
                <h2 id="res-title">WYNIK</h2>
                <div style="display: flex; justify-content: space-around; font-size: 1.2em; margin: 20px 0;">
                    <div>Cel: <div class="room-code" id="res-target">?</div></div>
                    <div>Strza≈Ç: <div class="room-code" id="res-guess">?</div></div>
                </div>
                <div id="res-points" style="font-size: 1.5em; color: #f1c40f; margin-bottom: 20px;">+0 pkt</div>
                <div id="host-next-turn" style="display:none;">
                    <button class="btn-primary" onclick="serverNextTurn()">Kontynuuj</button>
                </div>
            </div>

            <div id="screen-final" class="screen">
                <h2>KONIEC GRY</h2>
                <h1 id="winner-name">---</h1>
                <div id="final-leaderboard"></div>
                <div id="host-restart" style="display:none;">
                    <button class="btn-primary" onclick="location.reload()">Zagraj Ponownie</button>
                </div>
            </div>

        </div>
    </div>

    <div class="sidebar sidebar-right">
        <h3>üí¨ Status</h3>
        <div id="status-list">
            </div>
    </div>

<script>
    const CATS = [["Tanie", "Drogie"], ["Zimne", "GorƒÖce"], ["Nudne", "Ciekawe"], ["Z≈Çe", "Dobre"], ["Ma≈Çe", "Wielkie"], ["Lekkie", "Ciƒô≈ºkie"], ["Ciche", "G≈Ço≈õne"], ["≈Åagodne", "Ostre"]];
    const PREFIX = "spektrum-v3-";
    let peer, myConn, hostConns = [], isHost = false, myNick = "";
    
    let state = {
        phase: 'LOBBY', // LOBBY, HINTING, GUESSING, RESULT, FINAL
        players: [], // {id, nick, score, ready, role, hintDone, cat:[], word:''}
        totalRounds: 2,
        currentRound: 1,
        turnIndex: 0, // Kto teraz zgaduje (indeks w tablicy players)
        target: 5,
        guess: 0,
        hintIdx: 0
    };

    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function error(m) { document.getElementById('error-msg').innerText = m; setTimeout(()=>document.getElementById('error-msg').innerText="", 3000); }

    // --- LOGIKA PO≈ÅƒÑCZE≈É ---
    function createGame() {
        myNick = document.getElementById('host-nick').value || "Hoster";
        state.totalRounds = parseInt(document.getElementById('total-rounds').value);
        let code = Math.floor(1000 + Math.random()*9000).toString();
        isHost = true;
        peer = new Peer(PREFIX + code);
        peer.on('open', id => {
            state.players.push({id, nick: myNick, score: 0, ready: true, isHost: true});
            document.getElementById('display-code').innerText = code;
            document.getElementById('controls-host').style.display = 'block';
            showScreen('screen-lobby'); render();
            peer.on('connection', c => {
                c.on('data', d => handleServerData(d, c));
                hostConns.push(c);
            });
        });
        peer.on('error', e => e.type === 'unavailable-id' ? createGame() : error("B≈ÇƒÖd sieci."));
    }

    function joinGame() {
        myNick = document.getElementById('join-nick').value || "Gracz";
        let code = document.getElementById('join-code').value;
        peer = new Peer();
        peer.on('open', () => {
            myConn = peer.connect(PREFIX + code);
            myConn.on('open', () => {
                myConn.send({type: 'JOIN', nick: myNick});
                document.getElementById('display-code').innerText = code;
                document.getElementById('controls-client').style.display = 'block';
                showScreen('screen-lobby');
            });
            myConn.on('data', d => { state = d; render(); });
        });
    }

    // --- SERWER (HOST) ---
    function handleServerData(d, conn) {
        let p = state.players.find(x => x.id === conn.peer);
        if(d.type === 'JOIN') state.players.push({id: conn.peer, nick: d.nick, score: 0, ready: false, isHost: false});
        if(d.type === 'READY') if(p) p.ready = d.val;
        if(d.type === 'HINT') if(p) { p.word = d.word; p.hintDone = true; checkAllHints(); }
        if(d.type === 'NEXT') state.hintIdx++;
        if(d.type === 'GUESS') { state.guess = d.val; calcScore(); }
        broadcast();
    }

    function broadcast() { 
        render(); 
        hostConns.forEach(c => c.open && c.send(state)); 
    }

    function serverStartGame() {
        state.currentRound = 1;
        state.turnIndex = 0;
        newTurn();
    }

    function newTurn() {
        state.phase = 'HINTING';
        state.target = Math.floor(Math.random()*10) + 1;
        state.hintIdx = 0;
        state.players.forEach((p, i) => {
            p.hintDone = false;
            if(i === state.turnIndex) p.role = 'GUESSER';
            else {
                p.role = 'HINTER';
                p.cat = CATS[Math.floor(Math.random()*CATS.length)];
            }
        });
        broadcast();
    }

    function checkAllHints() {
        if(state.players.filter(p => p.role === 'HINTER' && !p.hintDone).length === 0) {
            state.phase = 'GUESSING';
        }
    }

    function calcScore() {
        let guesser = state.players[state.turnIndex];
        let pts = 0;
        let diff = Math.abs(state.target - state.guess);
        if(diff === 0) pts = 3;
        else if(diff === 1) pts = 1;
        guesser.score += pts;
        state.lastPoints = pts;
        state.phase = 'RESULT';
    }

    function serverNextTurn() {
        state.turnIndex++;
        if(state.turnIndex >= state.players.length) {
            state.turnIndex = 0;
            state.currentRound++;
        }
        if(state.currentRound > state.totalRounds) {
            state.phase = 'FINAL';
        } else {
            newTurn();
        }
        broadcast();
    }

    // --- KLIENT ---
    function toggleReady() {
        let me = state.players.find(p => p.id === peer.id);
        if(me) myConn.send({type: 'READY', val: !me.ready});
    }

    function clientSubmitHint() {
        let w = document.getElementById('hint-input').value.trim();
        if(!w) return;
        if(isHost) handleServerData({type:'HINT', word: w}, {peer: peer.id});
        else myConn.send({type: 'HINT', word: w});
        document.getElementById('hint-input').value = "";
    }

    function clientRequestNext() {
        if(isHost) handleServerData({type: 'NEXT'}, {peer: peer.id});
        else myConn.send({type: 'NEXT'});
    }

    function clientSubmitGuess() {
        let v = parseInt(document.getElementById('guess-range').value);
        if(isHost) handleServerData({type: 'GUESS', val: v}, {peer: peer.id});
        else myConn.send({type: 'GUESS', val: v});
    }

    // --- RENDEROWANIE ---
    function render() {
        // Lewy sidebar (Tabela wynik√≥w)
        const scoreTable = document.getElementById('score-table');
        scoreTable.innerHTML = state.players.sort((a,b)=>b.score-a.score).map(p => 
            `<div class="score-row"><b>${p.nick}</b> <span>${p.score} pkt</span></div>`).join('');
        document.getElementById('ui-current-round').innerText = state.currentRound;
        document.getElementById('ui-total-rounds').innerText = state.totalRounds;

        // Prawy sidebar (Status podpowiedzi)
        const statusList = document.getElementById('status-list');
        if(state.phase === 'HINTING') {
            statusList.innerHTML = state.players.filter(p=>p.role==='HINTER').map(p => 
                `<div class="status-item ${p.hintDone?'status-done':'status-pending'}">${p.nick}: ${p.hintDone?'GOTOWY':'MY≈öLI...'}</div>`).join('');
        } else {
            statusList.innerHTML = "<p style='font-size:0.8em; opacity:0.5'>Czekanie na fazƒô podpowiedzi...</p>";
        }

        // Ekrany g≈Ç√≥wne
        if(state.phase === 'LOBBY') {
            showScreen('screen-lobby');
            document.getElementById('lobby-list').innerHTML = state.players.map(p => 
                `<div>${p.nick} - ${p.ready?'‚úÖ':'‚è≥'}</div>`).join('');
            if(isHost) {
                const ready = state.players.length >= 2 && state.players.every(p=>p.ready);
                document.getElementById('btn-start').disabled = !ready;
                document.getElementById('btn-start').className = ready ? 'btn-primary' : 'btn-disabled';
            }
        } 
        else if(state.phase === 'HINTING') {
            showScreen('screen-hinting');
            let me = state.players.find(p => p.id === peer.id);
            if(me.role === 'GUESSER') {
                document.getElementById('view-guesser-wait').style.display = 'block';
                document.getElementById('view-hinter-active').style.display = 'none';
            } else {
                document.getElementById('view-guesser-wait').style.display = 'none';
                document.getElementById('view-hinter-active').style.display = me.hintDone ? 'none' : 'block';
                if(!me.hintDone) {
                    document.getElementById('hint-target-val').innerText = state.target;
                    document.getElementById('hint-marker-label').innerText = state.target;
                    document.getElementById('hint-marker').style.left = (state.target-1)*11.11 + "%";
                    document.getElementById('cat-left').innerText = me.cat[0];
                    document.getElementById('cat-right').innerText = me.cat[1];
                }
            }
        }
        else if(state.phase === 'GUESSING') {
            showScreen('screen-guessing');
            let guesser = state.players[state.turnIndex];
            let hinters = state.players.filter(p => p.role === 'HINTER');
            let h = hinters[state.hintIdx];
            
            document.getElementById('ui-guesser-name').innerText = guesser.nick;
            document.getElementById('ui-hinter-name').innerText = h.nick;
            document.getElementById('ui-hint-word').innerText = h.word;
            document.getElementById('guess-cat-left').innerText = h.cat[0];
            document.getElementById('guess-cat-right').innerText = h.cat[1];

            let isMeGuesser = peer.id === guesser.id;
            document.getElementById('guesser-controls').style.display = isMeGuesser ? 'block' : 'none';
            
            let isLastHint = state.hintIdx === hinters.length - 1;
            document.getElementById('btn-next').style.display = isLastHint ? 'none' : 'inline-block';
            document.getElementById('final-guess-ui').style.display = isLastHint ? 'block' : 'none';
        }
        else if(state.phase === 'RESULT') {
            showScreen('screen-result');
            document.getElementById('res-target').innerText = state.target;
            document.getElementById('res-guess').innerText = state.guess;
            document.getElementById('res-points').innerText = `+${state.lastPoints} pkt dla zgadujƒÖcego!`;
            document.getElementById('host-next-turn').style.display = isHost ? 'block' : 'none';
        }
        else if(state.phase === 'FINAL') {
            showScreen('screen-final');
            let winner = state.players.sort((a,b)=>b.score-a.score)[0];
            document.getElementById('winner-name').innerText = `Zwyciƒôzca: ${winner.nick}`;
            document.getElementById('host-restart').style.display = isHost ? 'block' : 'none';
        }
    }

    function updateGuessMarker(v) {
        document.getElementById('guess-val-display').innerText = v;
        document.getElementById('guess-marker-visual').style.left = (v-1)*11.11 + "%";
    }

</script>
</body>
</html>